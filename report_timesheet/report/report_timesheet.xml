<odoo>
    <data>

        <template id="assemat_worktype">
            <tr>
                <td name="description_name" t-attf-colspan="1" class="worksite_row" style="font-weight: 600; border-right: none;">
                    <span t-if="current_description" t-esc="current_description"/>
                    <span t-else="">Type de Travail Non Renseigné</span>
                </td>
                <td id="total_description" t-attf-colspan="{{nbCols}}-1" class="worksite_row text-end" style="border-left:none;"> <!-- border-bottom:none; border-top: 1px solid black !important -->
                        Sous-Total : <span t-esc="total_description" t-options="{'widget':'float_time'}"/>
                </td> 
            </tr>
            <tr t-foreach="current_lines" t-as="current_line">
                <td class="align-middle" style="border-right: 1px solid #dee2e6;">
                   <span t-esc="current_line['employee']"/>
                </td>
                <td t-if="show_project" class="align-middle" style="border-right: 1px solid #dee2e6;">
                    <span t-esc="current_line['project_id']"/>
                </td>
               
                <td class="text-end align-middle" id="line_time" style="border-left: 1px solid #dee2e6;">
                    <!-- t-else=""<span t-if="is_uom_day" t-esc="line._get_timesheet_time_day()" t-options="{'widget': 'timesheet_uom'}"/> -->
                    <span t-esc="current_line['worktime']" t-options="{'widget': 'duration', 'digital': True, 'unit': 'hour', 'round': 'minute'}"/>
                </td>
            </tr>
        </template>

        
        <record model="ir.ui.view" id="report_timesheet_group_by_task">
            <field name="name">BP Rapport Feuille de temps</field>
            <field name="inherit_id" ref="hr_timesheet.timesheet_table"/>
            <field name="arch" type="xml">

                <!-- Suppression colonne inutiles -->
                <xpath expr="/t/div/div/table/thead/tr/th[4]" position="replace"/>
                <xpath expr="/t/div/div/table/thead/tr/th[4]" position="replace"/>
                <xpath expr="/t/div/div/table/thead/tr/th[1]" position="replace"/>

                <xpath expr="/t/t" position="replace">
                    <t t-set="is_uom_day" t-value="is_uom_day"/>
                </xpath>
                
                <xpath expr="/t/div/div/table/tbody" position="replace">
                    <tbody>
 
                        <t t-set="nbCols" t-value="3"/>
                        <t t-if="show_project" t-set="nbCols" t-value="nbCols + 1"/>

                        <t t-set="current_lines" t-value="[]"/> 
                        <t t-set="current_task" t-value="init_value"/> 
                        <t t-set="total_task" t-value="0"/>
                        <t t-set="current_description" t-value="init_value"/>
                        <t t-set="total_description" t-value="0"/>

                        <tr t-foreach="lines" t-as="line">
                            <t t-if="line['task_id'] != current_task"> <!-- Si on change de tâche -->
                                <!-- Affichage du temps de la tâche -->
                                <t t-if="current_task != init_value"> 
                                    <t t-call="report_timesheet.assemat_worktype"/>
                                    <tr>
                                        <td id="total_task" t-attf-colspan="{{nbCols}}" class="task_row" style="border-bottom: none !important"> <!--  style="border: 1px solid black !important" -->
                                            Total <span t-esc="current_task"/>: <span t-esc="total_task"/>
                                        </td> 
                                    </tr>
                                </t>                                
                                <t t-set="total_task" t-value="0"/>
                                <!-- En-tête de la nouvelle tâche -->
                                <t t-set="current_description" t-value="new_task"/>
                                <t t-set="current_task" t-value="line['task_id']"/>
                                <tr>
                                    <td id="task_name" t-attf-colspan="{{nbCols}}" class="task_row" style="font-weight: bold; border-bottom: none !important">
                                        <span t-if="current_task" t-esc="current_task"/>
                                        <span t-else="">Tâche Non Renseignée</span>
                                    </td>
                                </tr>
                            </t>
                            <t t-if="line['worktype'] == current_description and current_description != new_task">
                                <t t-set="current_lines" t-value="current_lines + [line]"/>
                                <t t-set="total_description" t-value="total_description + line['worktime']"/>
                            </t>
                            <t t-else=""> <!-- Si on change de type de travaux -->
                                <t t-if="current_description != init_value" t-call="report_timesheet.assemat_worktype"/>
                                
                                <t t-set="current_description" t-value="line['worktype']"/>
                                <t t-set="total_description" t-value="line['worktime']"/>
                                <t t-set="current_lines" t-value="[line]"/>
                            </t>
                            <t t-set="total_task" t-value="total_task + line['worktime']"/>
                        </tr>
                        
                        <t t-call="report_timesheet.assemat_worktype"/> <!-- Pour afficher le dernier type de travaux -->
                        <!-- Sous-total horaire de la dernière tâche -->
                        <tr>
                            <td id="total_task" t-attf-colspan="{{nbCols}}" class="task_row" style="border-top: 1px solid black;">
                                Total <span t-esc="current_task"/>: <span t-esc="total_task" t-options="{'widget':'float_time'}"/>
                            </td>
                        </tr>
                        
                        <!-- Total horaire -->
                        <tr>
                            <td class="text-end" t-attf-colspan="{{nbCols}}" style="background-color:rgba(0, 0, 0, 0.9); color:#fff;">
                                <strong t-if="is_uom_day">
                                    <span style="margin-right: 15px;">Total (Jours)</span>
                                    <t t-esc="lines._convert_hours_to_days(sum([line['worktime'] for line in lines]))" t-options="{'widget': 'timesheet_uom'}"/>
                                </strong>
                                <strong t-else="">
                                    <span style="margin-right: 15px;">Total (Heures)</span>
                                    <t t-esc="sum([line['worktime'] for line in lines])" t-options="{'widget': 'duration', 'digital': True, 'unit': 'hour', 'round': 'minute'}"/>
                                </strong>
                            </td>
                        </tr>                        
                    </tbody>
                </xpath>
                
                <!-- Style lignes tâches-->                
                <xpath expr="/t/div/div/table/tbody//td[@id='total_task']/span[2]" position="attributes">
                    <attribute name="t-options-widget">"float_time"</attribute>
                </xpath>
                
            </field>
        </record>

        <record model="ir.ui.view" id="report_timesheet_call">
            <field name="name">BP - Rapport Feuille de temps</field>
            <field name="inherit_id" ref="hr_timesheet.report_timesheet"/>
            <field name="arch" type="xml">

                <xpath expr="/t/t/t/div/t" position="replace">
                    <t t-set="lines" t-value="lines_ordered"/>
                </xpath>
            </field>
        </record>

        <record model="ir.ui.view" id="report_timesheet_task_call">
            <field name="name">BP - Rapport Feuille de temps</field>
            <field name="inherit_id" ref="hr_timesheet.timesheet_project_task_page"/>
            <field name="arch" type="xml">

                <xpath expr="/t/t[4]/t/div/t/div[2]/div/t/t" position="replace">
                    <t t-set="lines" t-value="_get_timesheet_line(doc.id)"/>
                </xpath>

                <xpath expr="/t/t[4]/t/div/t/div[2]/div/t/h2/span" position="replace">
                    <span>Feuille de temps
                        <t t-if="show_record">
                             : <t t-out="doc.name"/>
                        </t>
                    </span>
                </xpath>

                <xpath expr="/t/t[4]/t/div/t" position="before">
                    <head>
                         <style>
                            .task_row {background-color: #B37A51 !important; color:black !important;}
                            .worksite_row {background-color: #DFC6B3 !important; color:black !important;}
                            
                            #total_task {text-align: right; background-color: white !important; color: black !important}
                            
                            #line_time {background-color:white !important}
                            
                            td {border-color: #dee2e6}
                        </style>
                    </head>
                </xpath>
            </field>
        </record>
        
    </data>
</odoo>