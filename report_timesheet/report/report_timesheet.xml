<odoo>
    <data>
        <record model="ir.ui.view" id="report_timesheet_group_by_task">
            <field name="name">BP Rapport Feuille de temps</field>
            <field name="inherit_id" ref="hr_timesheet.timesheet_table"/>
            <field name="arch" type="xml">

                <!-- Suppression colonne inutiles -->
                <xpath expr="/t/div/div/table/thead/tr/th[4]" position="replace"/>
                <xpath expr="/t/div/div/table/thead/tr/th[4]" position="replace"/>
                <xpath expr="/t/div/div/table/thead/tr/th[1]" position="replace"/>

                <xpath expr="/t/t" position="replace">
                    <t t-set="is_uom_day" t-value="is_uom_day"/>
                </xpath>
                
                <xpath expr="/t/div/div/table/tbody" position="replace">
                    <tbody>
 
                        <t t-set="nbCols" t-value="3"/>
                        <t t-if="show_project" t-set="nbCols" t-value="nbCols + 1"/>

                        <t t-set="current_task" t-value="init_value"/> 
                        <t t-set="total_task" t-value="0"/>
                        <t t-set="current_description" t-value="init_value"/>
                        <t t-set="total_description" t-value="0"/>

                        <tr t-foreach="lines" t-as="line">    
                            <!-- Si on change de tâche -->
                            <t t-if="line['task_id'] != current_task">
                                <!-- Affichage du temps du type de travaux -->
                                <t t-if="current_description != init_value"> 
                                    <tr>
                                        <td id="total_description" t-attf-colspan="{{nbCols}}" class="worksite_row">
                                            Sous-Total <span t-esc="current_description"/> : <span t-esc="total_description"/>
                                        </td> 
                                    </tr>
                                    <t t-set="current_description" t-value="init_value"/>
                                </t>      
                                <!-- Affichage du temps de la tâche -->
                                <t t-if="current_task != init_value"> 
                                    <tr>
                                        <td id="total_task" t-attf-colspan="{{nbCols}}" class="task_row" >
                                            Total <span t-esc="current_task"/>: <span t-esc="total_task"/>
                                        </td> 
                                    </tr>
                                </t>                                
                                <t t-set="total_task" t-value="0"/>
                                <!-- En-tête de la nouvelle tâche -->
                                <t t-set="current_task" t-value="line['task_id']"/>
                                <tr>
                                    <td id="task_name" t-attf-colspan="{{nbCols}}" class="task_row" style="font-weight: bold;">
                                        <span t-if="current_task" t-esc="current_task"/>
                                        <span t-else="">Tâche Non Renseignée</span>
                                    </td>
                                </tr>
                            </t>
                            
                            
                             <!-- Si on change de type de travaux -->
                            <t t-if="line['worktype'] != current_description">
                                <!-- Affichage du temps du type de travaux -->
                                <t t-if="current_description != init_value"> 
                                    <tr>
                                        <td id="total_description" t-attf-colspan="{{nbCols}}" class="worksite_row">
                                            Sous-Total <span t-esc="current_description"/> : <span t-esc="total_description"/>
                                        </td> 
                                    </tr>
                                </t>                                
                                <t t-set="total_description" t-value="0"/>
                                <!-- En-tête du nouveau type de travaux -->
                                <t t-set="current_description" t-value="line['worktype']"/>
                                <tr>
                                    <td name="description_name" t-attf-colspan="{{nbCols}}" class="worksite_row" style="font-weight: 600;">
                                        <span t-if="current_description" t-esc="current_description"/>
                                        <span t-else="">Type de Travail Non Renseigné</span>
                                    </td>
                                </tr>
                            </t>
                            <t t-set="total_description" t-value="total_description + line['worktime']"/>
                            <t t-set="total_task" t-value="total_task + line['worktime']"/>
                            
                            <!-- Affichage des données -->
                            <td class="align-middle">
                               <span t-esc="line['employee']"/>
                            </td>
                            <td t-if="show_project" class="align-middle">
                                <span t-esc="line['project_id']"/>
                            </td>
                           
                            <td class="text-end align-middle" id="line_time">
                                <!-- t-else=""<span t-if="is_uom_day" t-esc="line._get_timesheet_time_day()" t-options="{'widget': 'timesheet_uom'}"/> -->
                                <span t-esc="line['worktime']" t-options="{'widget': 'duration', 'digital': True, 'unit': 'hour', 'round': 'minute'}"/>
                            </td>
                        </tr>
                        
                        <!-- Sous-total horaire de la dernière tâche -->
                        <tr>
                            <td id="total_description" t-attf-colspan="{{nbCols}}" class="worksite_row">
                                Sous-Total <span t-esc="current_description"/> : <span t-esc="total_description"/>
                            </td>
                        </tr>
                        <tr>
                            <td id="total_task" t-attf-colspan="{{nbCols}}" class="task_row">
                                Total <span t-esc="current_task"/>: <span t-esc="total_task"/>
                            </td>
                        </tr>
                        
                        <!-- Total horaire -->
                        <tr>
                            <td class="text-end" t-attf-colspan="{{nbCols}}">
                                <strong t-if="is_uom_day">
                                    <span style="margin-right: 15px;">Total (Days)</span>
                                    <t t-esc="lines._convert_hours_to_days(sum([line['worktime'] for line in lines]))" t-options="{'widget': 'timesheet_uom'}"/>
                                </strong>
                                <strong t-else="">
                                    <span style="margin-right: 15px;">Total (Hours)</span>
                                    <t t-esc="sum([line['worktime'] for line in lines])" t-options="{'widget': 'duration', 'digital': True, 'unit': 'hour', 'round': 'minute'}"/>
                                </strong>
                            </td>
                        </tr>
                        
                    </tbody>
                </xpath>
                
                <!-- Style lignes tâches-->                
                <xpath expr="/t/div/div/table/tbody//td[@id='total_task']/span[2]" position="attributes">
                    <attribute name="t-options-widget">"float_time"</attribute>
                </xpath>
                
                <!-- Style lignes types de travaux -->
                <xpath expr="//td[@id='total_description']/span[2]" position="attributes">
                    <attribute name="t-options-widget">"float_time"</attribute>
                </xpath>
                
                <xpath expr="/t/div/div/table/tbody/tr/t[2]//td[@id='total_description']/span[2]" position="attributes">
                    <attribute name="t-options-widget">"float_time"</attribute>
                </xpath>
                
                <!--Style lignes de fin -->
                <xpath expr="/t/div/div/table/tbody/tr[2]/td/span[2]" position="attributes">
                    <attribute name="t-options-widget">"float_time"</attribute>
                </xpath>
                
                <xpath expr="/t/div/div/table/tbody/tr[3]/td/span[2]" position="attributes">
                    <attribute name="t-options-widget">"float_time"</attribute>
                </xpath>
                
            </field>
        </record>

        <record model="ir.ui.view" id="report_timesheet_call">
            <field name="name">BP - Rapport Feuille de temps</field>
            <field name="inherit_id" ref="hr_timesheet.report_timesheet"/>
            <field name="arch" type="xml">

                <xpath expr="/t/t/t/div/t" position="replace">
                    <t t-set="lines" t-value="lines_ordered"/>
                </xpath>
            </field>
        </record>

        <record model="ir.ui.view" id="report_timesheet_task_call">
            <field name="name">BP - Rapport Feuille de temps</field>
            <field name="inherit_id" ref="hr_timesheet.timesheet_project_task_page"/>
            <field name="arch" type="xml">

                <xpath expr="/t/t[4]/t/div/t/div[2]/div/t/t" position="replace">
                    <t t-set="lines" t-value="_get_timesheet_line(doc.id)"/>
                </xpath>

                <xpath expr="/t/t[4]/t/div/t/div[2]/div/t/h2/span" position="replace">
                    <span>Feuille de temps
                        <t t-if="show_record">
                             : <t t-out="doc.name"/>
                        </t>
                    </span>
                </xpath>

                <xpath expr="/t/t[4]/t/div/t" position="before">
                    <head>
                         <style>
                            .task_row {background-color: #B37A51 !important; color:white !important;} <!--  -->
                            .worksite_row {background-color: #BFA693 !important; color:black !important;}
                            
                            #total_task, #total_description {text-align: right; background-color: white !important; color: black !important}
                            
                            #line_time {background-color:white !important}
                        </style>
                    </head>
                </xpath>
            </field>
        </record>
        
    </data>
</odoo>